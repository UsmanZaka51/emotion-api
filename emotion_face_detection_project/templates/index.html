<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Face Detection</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="file"], select { 
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; 
            border-radius: 4px; box-sizing: border-box;
        }
        button { 
            background: #4CAF50; color: white; border: none; padding: 12px 20px; 
            cursor: pointer; border-radius: 4px; font-size: 16px;
        }
        button:hover { background: #45a049; }
        #results { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; }
        #preview { max-width: 300px; max-height: 300px; margin-top: 10px; display: none; }
        .video-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .video-card { width: 200px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
        .video-card img { width: 100%; height: 120px; object-fit: cover; }
        .progress-bar { width: 100%; background-color: #f1f1f1; border-radius: 4px; margin-top: 10px; }
        .progress { height: 20px; border-radius: 4px; background-color: #4CAF50; width: 0%; }
    </style>
</head>
<body>
    <h1>Emotion Face Detection System</h1>

    <div class="section">
        <h2>Upload Files</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label for="person_id">Person ID (for photos):</label>
                <input type="text" id="person_id" name="person_id" placeholder="Enter person identifier">
            </div>
            <div class="form-group">
                <label for="file">Select File (Photo or Video):</label>
                <input type="file" id="file" name="file" accept="image/*,video/*" required>
                <div id="filePreview">
                    <img id="preview" src="#" alt="Preview">
                    <video id="videoPreview" controls style="display:none; max-width: 300px;"></video>
                </div>
            </div>
            <button type="submit">Upload File</button>
        </form>
        <div id="uploadResults"></div>
    </div>

    <div class="section">
        <h2>Process Video for Emotion Detection</h2>
        <form id="processForm">
            <div class="form-group">
                <label for="videoSelect">Select Video to Process:</label>
                <select id="videoSelect" name="video_s3_key" required>
                    <option value="">Loading videos...</option>
                </select>
            </div>
            <button type="submit">Process Video</button>
        </form>
        <div id="processResults"></div>
        <div class="progress-bar" id="progressContainer" style="display:none;">
            <div class="progress" id="progressBar"></div>
        </div>
    </div>

    <div class="section">
        <h2>Available Videos</h2>
        <button id="refreshVideos">Refresh List</button>
        <div class="video-container" id="videoList"></div>
    </div>

    <script>
        // File preview
        document.getElementById('file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('preview');
            const videoPreview = document.getElementById('videoPreview');
            
            preview.style.display = 'none';
            videoPreview.style.display = 'none';

            if (file.type.startsWith('image/')) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            } else if (file.type.startsWith('video/')) {
                videoPreview.src = URL.createObjectURL(file);
                videoPreview.style.display = 'block';
            }
        });

        // Handle file upload
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('person_id', document.getElementById('person_id').value);
            formData.append('file', document.getElementById('file').files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                const resultsDiv = document.getElementById('uploadResults');
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div style="color: green;">
                            <p><strong>Success:</strong> ${result.message}</p>
                            <p><strong>S3 Path:</strong> ${result.s3_path}</p>
                            <p><strong>File Type:</strong> ${result.file_type}</p>
                        </div>
                    `;
                    // Refresh video list after upload
                    loadVideos();
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: red;">
                            <p><strong>Error:</strong> ${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('uploadResults').innerHTML = `
                    <div style="color: red;">
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        });

        // Load videos for processing
        async function loadVideos() {
            try {
                const response = await fetch('/videos');
                const data = await response.json();
                
                if (response.ok) {
                    const videoSelect = document.getElementById('videoSelect');
                    const videoList = document.getElementById('videoList');
                    
                    // Update dropdown
                    videoSelect.innerHTML = data.videos.length > 0 
                        ? data.videos.map(video => 
                            `<option value="${video.s3_key}">${video.s3_key.split('/').pop()}</option>`
                          ).join('')
                        : '<option value="">No videos available</option>';
                    
                    // Update video list display
                    videoList.innerHTML = data.videos.map(video => `
                        <div class="video-card">
                            <h3>${video.s3_key.split('/').pop()}</h3>
                            <p><strong>Person ID:</strong> ${video.person_id || 'N/A'}</p>
                            <p><strong>Uploaded:</strong> ${new Date(video.upload_time).toLocaleString()}</p>
                            <video width="100%" controls>
                                <source src="https://${S3_BUCKET}.s3.${AWS_REGION}.amazonaws.com/${video.s3_key}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `).join('');
                } else {
                    console.error('Error loading videos:', data.error);
                }
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }

        // Process video
        document.getElementById('processForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const videoSelect = document.getElementById('videoSelect');
            const resultsDiv = document.getElementById('processResults');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            if (!videoSelect.value) {
                resultsDiv.innerHTML = '<div style="color: red;">Please select a video</div>';
                return;
            }

            try {
                resultsDiv.innerHTML = '<div>Processing video...</div>';
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                
                // Simulate progress (in real app, use WebSocket or polling)
                const interval = setInterval(() => {
                    const width = parseInt(progressBar.style.width) || 0;
                    if (width < 90) {
                        progressBar.style.width = (width + 10) + '%';
                    }
                }, 1000);
                
                const response = await fetch('/process-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `video_s3_key=${encodeURIComponent(videoSelect.value)}`
                });

                clearInterval(interval);
                progressBar.style.width = '100%';
                
                const result = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div style="color: green;">
                            <p><strong>Success:</strong> ${result.message}</p>
                            <p><strong>Output Path:</strong> ${result.output_path}</p>
                            <p>Processing complete!</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: red;">
                            <p><strong>Error:</strong> ${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="color: red;">
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        });

        // Refresh videos button
        document.getElementById('refreshVideos').addEventListener('click', function(e) {
            e.preventDefault();
            loadVideos();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadVideos();
        });

        // Constants (should match your backend)
        const S3_BUCKET = 'my-emotion-model-bucket';
        const AWS_REGION = 'us-east-1';
    </script>
</body>
</html>
